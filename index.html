<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$BNKR 大户看板 (高级版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #0052ff; text-align: center; margin-bottom: 5px; }
        .info { text-align: center; color: #666; margin-bottom: 20px; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8f9fa; cursor: pointer; padding: 12px; font-size: 13px; color: #666; border-bottom: 2px solid #eee; }
        th:hover { background: #eef2ff; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px; word-break: break-all; }
        .balance { font-weight: bold; text-align: right; }
        .change-up { color: #00c087; font-weight: bold; }
        .change-down { color: #ff3b30; font-weight: bold; }
        .sold-out { background: #fff1f0; color: #cf1322; padding: 2px 5px; border-radius: 4px; font-size: 11px; }
        .trend-canvas { width: 100px !important; height: 30px !important; }
        .tag { background: #eef2ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>$BNKR 大户持仓监控</h1>
        <div id="updateTime" class="info">加载中...</div>
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="50">排名</th>
                    <th width="120">持币地址</th>
                    <th onclick="sortTable(2)" width="130" style="text-align: right;">余额 ▼</th>
                    <th width="80" style="text-align: right;">占比</th>
                    <th onclick="sortTable(4)" width="120" style="text-align: right;">24h变动</th>
                    <th width="110">持仓趋势</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const TOTAL_SUPPLY = 100000000000;
        const csvUrl = 'bnkr_holders_history.csv?v=' + Date.now();
        let globalData = [];

        function parseCSVLine(text) {
            const result = []; let cur = ''; let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                if (char === '"') inQuote = !inQuote;
                else if (char === ',' && !inQuote) { result.push(cur.trim()); cur = ''; }
                else cur += char;
            }
            result.push(cur.trim()); return result;
        }

        async function loadData() {
            const response = await fetch(csvUrl);
            const csvText = await response.text();
            const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
            const headers = parseCSVLine(lines[0]);
            
            const addrIdx = headers.findIndex(h => /Address|Holder/i.test(h));
            const balIdx = headers.findIndex(h => /Balance|Quantity/i.test(h));
            const changeIdx = headers.findIndex(h => /Change/i.test(h));
            const dateIdx = headers.findIndex(h => /Date/i.test(h));

            const rawData = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols[addrIdx]) {
                    rawData.push({
                        addr: cols[addrIdx],
                        bal: parseFloat(cols[balIdx].replace(/,/g, '')) || 0,
                        change: changeIdx !== -1 ? parseFloat(cols[changeIdx]) : 0,
                        date: cols[dateIdx] || "初始"
                    });
                }
            }

            const latestDate = rawData[rawData.length-1].date;
            document.getElementById('updateTime').innerText = `最后更新: ${latestDate} (北京时间) | 总量: 100B`;

            // 聚合地址历史用于画图
            const addrGroups = {};
            rawData.forEach(r => {
                if (!addrGroups[r.addr]) addrGroups[r.addr] = [];
                addrGroups[r.addr].push(r.bal);
            });

            // 提取最新一帧
            globalData = Object.keys(addrGroups).map(addr => {
                const history = addrGroups[addr];
                const currentBal = history[history.length - 1];
                const lastBal = history.length > 1 ? history[history.length - 2] : currentBal;
                return {
                    addr,
                    bal: currentBal,
                    change: currentBal - lastBal,
                    history: history.slice(-7), // 记录最近7次
                    percent: (currentBal / TOTAL_SUPPLY * 100).toFixed(4) + '%'
                };
            }).sort((a,b) => b.bal - a.bal).slice(0, 200);

            renderTable(globalData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach((row, i) => {
                const isSoldOut = row.bal < 1;
                const changeClass = row.change > 0 ? 'change-up' : (row.change < 0 ? 'change-down' : '');
                const changeText = row.change > 0 ? `+${row.change.toLocaleString()}` : (row.change < 0 ? row.change.toLocaleString() : '-');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="tag">${i+1}</span></td>
                    <td><a style="text-decoration:none; color:#0052ff; font-family:monospace;" href="https://basescan.org/address/${row.addr}" target="_blank">${row.addr.substring(0,6)}...${row.addr.substring(36)}</a></td>
                    <td class="balance">${isSoldOut ? '<span class="sold-out">已卖完</span>' : row.bal.toLocaleString()}</td>
                    <td style="text-align:right;">${row.percent}</td>
                    <td style="text-align:right;" class="${changeClass}">${changeText}</td>
                    <td><canvas class="trend-canvas" id="chart-${i}"></canvas></td>
                `;
                tbody.appendChild(tr);
                drawMiniChart(`chart-${i}`, row.history);
            });
        }

        function drawMiniChart(id, data) {
            new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: data, datasets: [{ data: data, borderColor: '#0052ff', borderWidth: 1.5, pointRadius: 0, fill: false }]},
                options: { events: [], scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false } } }
            });
        }

        function sortTable(type) {
            if (type === 2) globalData.sort((a,b) => b.bal - a.bal);
            if (type === 4) globalData.sort((a,b) => Math.abs(b.change) - Math.abs(a.change));
            renderTable(globalData);
        }

        loadData();
    </script>
</body>
</html>
